<!doctype html>
<meta charset="UTF-8"> 
<html>
  <button onclick="go()">Go</button>
  <p id="test"></p>
  <script src="https://tonejs.github.io/build/Tone.min.js"></script>
  <script>
    var generator;
    var synth;
    var synth2;
    var g = true;

    var nextUpdate = 0.0;
    var increment = 1.0;
    var lookAhead = 1.0;

    var Module = {
      onRuntimeInitialized: function() {
        console.log('Testing');

        var theme = new Module.Theme();
        //var test = new Module.TestRule();
        var melodyBuilder = new Module.StepMelodyBuilder();
        var h = new Module.BasicHarmonyRule();
        var p = new Module.StructuredGeneratorRule();
        var nr = new Module.BasicAbsoluteNoteRule();
        var t = new Module.AbsoluteTonicRule(72);
        var s = new Module.AbsoluteSubdivisionRule(4);
        var tt = new Module.AbsoluteTempoRule(95);
        var ss = new Module.BasicScaleRule(Module.SCALE.MAJOR);
        var vec = new Module.IntVector();
        vec.push_back(0);
        vec.push_back(3);
        vec.push_back(0);
        vec.push_back(4);
        var c = new Module.ScaleChordProgressionRule(vec);

        theme.addRule(p);
        theme.addRule(melodyBuilder);
        theme.addRule(h);
        theme.addRule(nr);
        theme.addRule(t);
        theme.addRule(s);
        theme.addRule(tt);
        theme.addRule(ss);
        theme.addRule(c);
        generator = theme.getGenerator();

        synth = new Tone.PolySynth(5, Tone.Synth).toMaster();

        console.log('Start');
        updateTime()
      }
    };

    function go()
    {
      g = false;
      console.log("Stopping");
    }

    function scheduleNote(note, duration)
    {
      synth.triggerAttackRelease(Tone.Frequency(note.key, "midi"), duration, note.time + 1);
    }

    function updateTime(){
      if (g)
      {
        requestAnimationFrame(updateTime);
      }
      document.getElementById("test").innerHTML = Tone.now().toFixed(3);

      if (Tone.now() >= nextUpdate)
      {
        var currentTime = Tone.now();
        nextUpdate = currentTime + increment;
        var stream = generator.getNext(nextUpdate + lookAhead);
        var notes = [];

        while(stream.hasNext())
        {
          var note = stream.getNext();
          if (note.isNoteOn)
          {
            notes.push(note);
          }
          else
          {
            for (var i = 0; i < notes.length; ++i)
            {
              if (notes[i].key == note.key && notes[i].channel == note.channel)
              {
                scheduleNote (notes[i], note.time - notes[i].time);
                if (note.time - notes[i].time < 2)
                  console.log(note.key);
                notes.splice(i, 1);
                break;
              }
            }
          }
        }
      }
    }

  </script>
  <script src="js/MusAI.js"></script>
</html>